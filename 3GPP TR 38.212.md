# 5G NR Multiplexing and channel coding
---
Input: MAC PDU (bytes)                                          
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CRC é™„åŠ  (crc_byte.c)         â”‚    
â”‚ Output: bits + CRC           â”‚    5.1 CRC calculation
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Physical-layer HARQ processing â”‚
â”‚ Output: encoded bits         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Segmentation (nr_segmentation.c) â”‚  5.2 Code block segmentation and code block CRC attachment
â”‚ Output: LDPC segments (bits) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LDPC ç·¨ç¢¼ (nr_dlsch_coding.c + CODING/) â”‚   5.2.2 Low density parity check coding
â”‚ Output: encoded bits         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rate Matching + Interleaving â”‚   6.2.5 Rate Matching
â”‚ Output: RM bits              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Scrambling                   â”‚
â”‚ Output: RM bits              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èª¿è®Š (Modulation: QPSK, 16QAM) â”‚
â”‚ Output: complex symbols (IQ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Resource Grid Mapping â”‚
â”‚ Output: complex symbols (IQ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Insert DMRS (UE uplink reference signal) â”‚
â”‚ Output: complex symbols (IQ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DFT-s-OFDM IFFT + CP åŠ å…¥ (ofdm_mod.c) â”‚
â”‚ Output: time-domain samples â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¨¡æ“¬é€šé“:  â”‚
â”‚ Input: TX samples            â”‚
â”‚ Output: RX samples           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“






## CH4 Mapping to physical channels 
- Uplink
  
| Transport Channel (TrCH) | å°æ‡‰ Physical Channel                   |
| ------------------------ | ------------------------------------- |
| UL-SCHï¼ˆUplink-Share Channel)           | PUSCHï¼ˆPhysical Uplink Shared Channelï¼‰ |
| RACHï¼ˆRandom Access Channelï¼‰             | PRACHï¼ˆPhysical Random Access Channelï¼‰ |

-Downlink

| Transport Channel (TrCH) | å°æ‡‰ Physical Channel                     |
| ------------------------ | --------------------------------------- |
| DL-SCHï¼ˆDownlink-Share Channel)           | PDSCHï¼ˆPhysical Downlink Shared Channelï¼‰ |
| BCHï¼ˆBroadcast Channelï¼‰                | PBCHï¼ˆPhysical Broadcast Channelï¼‰        |

## CH5 General procedures
- Channel coding scheme is a combination of error detection, error correcting, rate matching,
interleaving and transport channel or control information mapping onto/splitting from physical channels.

### 5.1 CRC calculation 
- Systematic Form ç·¨ç¢¼ï¼šè³‡æ–™åŸæ¨£ä¿ç•™ï¼ŒCRC é™„åŠ åœ¨å¾Œé¢ã€‚
- The parity bits are generated by one of
the following cyclic generator polynomials: 
  ![image](https://github.com/user-attachments/assets/4bbee2e3-d5fb-4182-a2dd-5f486e6772bc)

- æŠŠè¼¸å…¥è³‡æ–™ bits çœ‹æˆä¸€å€‹å¤šé …å¼ï¼š
![image](https://github.com/user-attachments/assets/17923298-a7ba-4fcb-8a21-aedbbe89f418)

æŠŠè³‡æ–™å¾€å·¦å¹³ç§» L ä½ï¼ˆé ç•™ç©ºé–“çµ¦ CRCï¼‰é™¤ä»¥g(x)å–å‡ºé¤˜æ•¸ï¼ˆR(x)ï¼‰ï¼Œä½œç‚º parity bitsï¼ˆCRCï¼‰
æœ€çµ‚é€å‡ºè³‡æ–™ç‚ºï¼š
![image](https://github.com/user-attachments/assets/feeb794b-9659-4057-82bf-a83733cc7c21)

- å‚³é€ç«¯ä¾æ“šä¸Šè¿°æ–¹å¼ç”¢ç”Ÿ parity bits ä¸¦é™„åŠ æ–¼è³‡æ–™å¾Œ
- æ¥æ”¶ç«¯é‡åšæ•´å€‹å¤šé …å¼é™¤æ³•ï¼š T(x)mod g(x)
   - è‹¥é¤˜æ•¸ç‚º 0 â†’ è³‡æ–™ç„¡èª¤
   - è‹¥é¤˜æ•¸ â‰  0 â†’ æœ‰éŒ¯èª¤
### 5.2 Code block segmentation and code block CRC attachment
#### 5.2.2 Low density parity check coding
| Base Graph | æœ€å¤§ code block é•·åº¦ $K_{cb}$ |
| ---------- | ------------------------- |
| BG1        | 8448 bits                 |
| BG2        | 3840 bits                 |
- STEP1: if B > Kcb
  - è¦å°‡è³‡æ–™åˆ†æˆ C æ®µ code block
  - æ¯æ®µå¾Œé¢åŠ ä¸Š L = 24 bits çš„ CRC24B
- else
  - C = 1
  - ä¸åŠ  CRCï¼ˆL = 0ï¼‰       
  - B'= B
- STEP2:  C=â¡B/(Kcbâˆ’24)â¤â†ceiling(ç„¡æ¢ä»¶é€²ä½)Bâ€²=B+24Ã—Câ†åŠ ä¸Šæ‰€æœ‰CRCbitså¾Œçš„ç¸½é•·åº¦
  - æ¯æ®µ block çš„ç¸½é•·åº¦ï¼š ğ¾=ğµâ€²/ğ¶ï¼Œè€Œå¯¦éš›é€²å…¥ LDPC ç·¨ç¢¼çš„æ˜¯å‰é¢ K'=K-24(CRCé•·åº¦)
- STEP3: æ‰¾åˆ°æœ€å°çš„Zæ»¿è¶³ ZÃ—Kbâ‰¥Kâ€² ï¼Œ
  - BG1-> Kb=22 
  - BG2->
    
| BG2 æ¢ä»¶     | Kb å€¼ |
| ------------ | ---- |
| B > 640      | 10   |
| 560 < B â‰¤640 | 9    |
| 192 < B â‰¤560 | 8    |
| B â‰¤192       | 6    |

![image](https://github.com/user-attachments/assets/b5226c6a-bd58-4050-bbcb-b2b010cf4af2)
å¾æ­¤è¡¨æ‰¾åˆ°Zcï¼Œä¹Ÿèƒ½æ‰¾åˆ°iLs
![image](https://github.com/user-attachments/assets/5ebb2d9d-1e65-4387-bfe2-8d3fe7c6ec3a)
- STEP4: ä»¥BGã€iLsæ‰¾åˆ°å°æ‡‰çš„HBGçŸ©é™£ï¼Œæ¯å€‹éƒ½å¾ˆå¤§ï¼ŒBG1ç‚ºä¾‹ï¼ŒHBGæ˜¯46*68çš„çŸ©é™£ï¼Œæ¯å€‹å…ƒç´ è¦å†å±•é–‹æˆZc*Zcçš„å–®ä½çŸ©é™£ï¼Œè€Œæ­¤æ•¸å­—è¡¨ç¤ºä½ç§»çš„æ¬¡æ•¸ï¼Œ
- STEP5: ä»¥Zcç‚ºä¾‹ï¼Œæœ€çµ‚å¾—åˆ°ä¸€å€‹å¤§å°ç‚º 46Ã—384 è¡Œ Ã— 68Ã—384 åˆ—ï¼ˆå…± 17664 Ã— 26112ï¼‰çš„çŸ©é™£Hã€‚
- STEP6: å®šç¾© codeword bit å‘é‡ï¼šd=[do,d1,...d26111]ï¼Œè¼¸å…¥è³‡æ–™C=8448bitsï¼Œæœƒå¾dçš„2*384ä½å…ƒé–‹å§‹å¡
- codeword d[0:26111] = [ d[0] ~ d[767] ]-----[ d[768] ~ d[9215] ]-----[ d[9216] ~ d[26111] ]<br>
--------------------------â†‘ Parity bits â†‘-----â†‘ c[0] ~ c[8447] â†‘------â†‘ å‰©ä¸‹æ˜¯ paddingï¼ˆNULL)â†‘

â€‹- STEP7:è¦æ»¿è¶³ï¼šHâ‹…d^T=0
 - å¯¦éš›åšæ³•ï¼šæŠŠ H åˆ†ç‚ºå…©éƒ¨åˆ†ï¼šH=[Hpâˆ£Hs]
   - Hpï¼šå‰ 768 å€‹ columnsï¼ˆparity bitsï¼‰
   - Hsï¼šå¾Œ 8448 å€‹ columnsï¼ˆdata bitsï¼‰
   - æŠŠè³‡æ–™éƒ¨åˆ†ä»£å…¥å¾Œï¼Œè§£ï¼šHp â‹… W^T=Hs â‹… C^T => W=(Hp^-1) â‹… (Hs â‹… C^T)
   - W=[w0...w767]=[d0...d767]  (å¯¦å‹™ä¸Šä¸æœƒç›´æ¥æ±‚ inverseï¼Œè€Œæ˜¯ç”¨é«˜æ–¯æ¶ˆå»æˆ–é¡ä¼¼æ³•ï¼ŒOAIå¯¦ä½œç‚ºXORåŠ ç¸½ï¼‰
### 5.4 Rate matching
#### 5.4.2 Rate Matching for LDPC Code
Rate Matching é©ç”¨æ–¼æ¯ä¸€å€‹ LDPC ç·¨ç¢¼å¾Œçš„ code block
- 1. Bit Selection
è¼¸å…¥ï¼šLDPC ç·¨ç¢¼ç”¢ç”Ÿçš„ bit åºåˆ— d[0] ...d[N-1]ï¼Œå°‡ d å¯«å…¥ä¸€å€‹é•·åº¦ç‚º Ncb çš„ circular bufferï¼Œå¦‚æœ LBRM = 0ï¼Œå‰‡ Ncb = Nï¼Œå¦å‰‡ Ncb = min(N, Nref)
** Nref æ ¹æ“š base graphã€TBSã€layer æ•¸ã€modulation orderã€coding rate ç­‰æ¢ä»¶è¨ˆç®—ï¼ˆè¦‹ TS 38.214ï¼‰
- 2. Bit Interleaving
  - å°‡ E å€‹é¸å‡ºçš„ bits e[0] ~ e[E-1] åš interleavingï¼Œå¾—åˆ° f[0] ~ f[E-1]
  - æ ¹æ“š modulation order Qmï¼ˆä¾‹å¦‚ QPSK=2, 16QAM=4, 64QAM=6, 256QAM=8ï¼‰é€²è¡Œé †åºæ‰“äº‚
## CH6 Uplink transport channels and control information
### 6.2 Uplink shared channel 
#### 6.2.2 LDPC Base Graph é¸æ“‡
- ä¾æ“š payload å¤§å° Aï¼ˆå« CRCï¼‰ èˆ‡ code rate Rï¼ˆç”± MCS æ±ºå®šï¼‰é¸æ“‡ Base Graphï¼š
  ä½¿ç”¨ Base Graph 2ï¼ˆBG2ï¼‰ çš„æ¢ä»¶ï¼š
  - A â‰¤ 292ï¼Œæˆ–
  - A â‰¤ 3824 ä¸” R â‰¤ 0.67ï¼Œæˆ–
  - R â‰¤ 0.25ï¼Œ
å¦å‰‡ä½¿ç”¨ Base Graph 1ï¼ˆBG1ï¼‰
#### 6.2.5 Rate Matching
- è¼¸å…¥ï¼šdâ‚€^{(r)}, ..., d_{N_r -1}^{(r)}
  - æ¯å€‹ CB ç¨ç«‹é€²è¡Œ Rate Matchingï¼ˆåƒè€ƒ 5.4.2ï¼‰
  - æ ¹æ“šé«˜å±¤åƒæ•¸ rateMatching æ±ºå®šæ˜¯å¦å•Ÿç”¨ Limited Buffer Rate Matchingï¼ˆLBRMï¼‰
  - rateMatching = limitedBufferRM â‡’ I_LBRM = 1
  - å¦å‰‡ I_LBRM = 0
- è¼¸å‡ºï¼šfâ‚€^{(r)}, ..., f_{E_r -1}^{(r)}ï¼ˆæ¯å€‹ CB ç¶“éåŒ¹é…å¾Œç‚º E_r å€‹ä½å…ƒï¼‰
```
Transport Block (B bits, å«CRC)
        â†“
[6.2.3] Code Block åˆ†æ®µ + CB CRC
        â†“
[6.2.4] LDPC ç·¨ç¢¼ï¼ˆæ¯å€‹ CBï¼‰
        â†“
[6.2.5] Rate Matchingï¼ˆæ¯å€‹ CBï¼‰
        â†“
[6.2.6] CB åˆä½µï¼ˆConcatenationï¼‰
        â†“
æœ€çµ‚ä¸Šè¡Œå‚³é€ä½å…ƒ gâ‚€, ..., g_{G-1}
```
#### 6.2.7 Data and control multiplexing 
- åœ¨ PUSCH å°‡ï¼ˆUL-SCHï¼‰å’Œæ§åˆ¶ä¿¡æ¯ï¼ˆHARQ-ACKã€CSIã€CG-UCIï¼‰MIXæˆä¸€å€‹ç·¨ç¢¼æ¯”ç‰¹åºåˆ—ï¼Œä¸¦åˆ†é…åˆ° OFDM ç¬¦è™Ÿå’Œå­è¼‰æ³¢çš„è³‡æºå…ƒç´ ä¸Šã€‚
- è€ƒæ…®äº†ä»¥ä¸‹å› ç´ ï¼š
  - frequency hopping
    ![image](https://github.com/user-attachments/assets/47360570-d41b-415b-8c1c-ea8a58e22de3)
  - DMRS ç¬¦è™Ÿçš„å½±éŸ¿ï¼ˆä¸æ”œå¸¶ UCIï¼‰ã€‚
  - æ§åˆ¶ä¿¡æ¯çš„å„ªå…ˆç´šï¼ˆå¦‚ HARQ-ACK æ¯” CSI å„ªå…ˆï¼‰ã€‚
    ![image](https://github.com/user-attachments/assets/1bc23d8e-7e2c-460c-a125-1a99716e969c)
  - èª¿è£½éšæ•¸ Qm å’Œå‚³è¼¸å±¤æ•¸ NL çš„å½±éŸ¿ã€‚
    ![image](https://github.com/user-attachments/assets/56a0c142-6baa-4cc4-8c59-1a36fd9fef92)
- åˆ†æˆ6å€‹STEP:
  - Step 1: åˆå§‹åŒ–è³‡æºé›†åˆèˆ‡é ç•™ HARQ-ACK è³‡æº
  - Step 2ï¼šå„ªå…ˆè™•ç† HARQ-ACKï¼ˆæˆ–èˆ‡ CG-UCI è¯åˆç·¨ç¢¼ï¼‰ï¼Œåˆ†é… UCI è³‡æºã€‚
  - Step 2Aï¼šè™•ç†å–®ç¨çš„ CG-UCIï¼Œåˆ†é… UCI è³‡æºã€‚
  - Step 3ï¼šä¾æ¬¡è™•ç† CSI Part 1 å’Œ Part 2ï¼Œåˆ†é…å‰©é¤˜ UCI è³‡æºã€‚
  - Step 4ï¼šå°‡ UL-SCH æ•¸æ“šæ˜ å°„åˆ°å‰©é¤˜çš„ UL-SCH è³‡æºã€‚
  - Step 5ï¼šè™•ç†å°‘é‡ HARQ-ACKï¼ˆâ‰¤ 2 æ¯”ç‰¹ï¼‰ï¼Œä½¿ç”¨é ç•™è³‡æºã€‚
  - Step 6ï¼šç”Ÿæˆæœ€çµ‚çš„åºåˆ—ï¼Œå®Œæˆæ‰€æœ‰ä½å…ƒçš„æ˜ å°„ã€‚
 
    
